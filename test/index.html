<html>
    <head>
        <link rel="stylesheet" href="http://code.jquery.com/qunit/git/qunit.css" type="text/css" media="screen" />
        <script src="../lib/jquery.min.js" type="text/javascript">
        </script>
        <script type="text/javascript" src="http://code.jquery.com/qunit/git/qunit.js">
        </script>
        <script type="text/javascript" src="../jquery.indexeddb.js">
        </script>
        <script>
            
            var DB = {
            	NAME: "dbName",
            	OBJECT_STORE_1: "objectStore1",
            	OBJECT_STORE_2: "objectStore2",
            	OBJECT_STORE_3: "objectStore3",
            	OBJECT_STORE_4: "objectStore4",
            	INDEX1_ON_OBJECT_STORE_1: "Index1_ObjectStore1",
            	INDEX1_ON_OBJECT_STORE_2: "Index1_ObjectStore2"
            };
            
            function _(context, args, msg){
            	console.log(QUnit.config.current.module + ":" + QUnit.config.current.testName, msg || "", arguments.callee.caller.arguments);
            }
            
            var sample = {
            	obj: function(){
            		return {
            			"String": "Sample " + new Date(),
            			"Int": this.integer(),
            			"Float": Math.random(),
            			"Boolean": true
            		}
            	},
            	integer: function(arg){
            		return parseInt(Math.random() * (arg || 100));
            	}
            };
            
            $(document).ready(function(){
            	module("Database");
            	asyncTest("Sample test", function(){
            		$.indexedDB(DB.NAME).deleteDatabase().then(function(res, e){
            			ok(true, "Database Deleted successfully");
            			start();
            		}, function(err, e){
            			ok(false, "Could not delete database");
            			_("Could not delete database");
            			start();
            		}, function(res, e){
            			equal(e.type, "upgradeneeded", "Deletion in progress due to " + e.type);
            			start();
            			stop();
            		})
            	});
            	
            	asyncTest("Open Database without schema", function(){
            		$.indexedDB(DB.NAME).then(function(res, e){
            			ok(true, "Database opened successfully");
            			_("DB opened");
            			start();
            		}, function(err, e){
            			ok(false, "Could not open database" + e);
            			_("Could not open DB");
            			start();
            		}, function(res, e){
            			equals(e.type, "upgradeneeded", "Database opening blocked due to " + e.type);
            			_("DB Upgrade");
            			start();
            			stop();
            		});
            	});
            	
            	asyncTest("Open Database with schema", function(){
            		$.indexedDB(DB.NAME, {
            			"schema": {
            				"1": function(versionTransaction){
            					var objectStore1 = versionTransaction.createObjectStore(DB.OBJECT_STORE_1);
            					objectStore1.add(sample.obj(), sample.integer());
            					objectStore1.add(sample.obj(), sample.integer());
            					objectStore1.add(sample.obj(), sample.integer());
            					versionTransaction.createObjectStore(DB.OBJECT_STORE_3);
            				},
            				"2": function(versionTransaction){
            					var objectStore2 = versionTransaction.createObjectStore(DB.OBJECT_STORE_2, {
            						"keyPath": "id",
            						"autoIncrement": true
            					});
            					versionTransaction.objectStore(DB.OBJECT_STORE_1).each(function(elem){
            						objectStore2.add(elem.value);
            					});
            					versionTransaction.objectStore(DB.OBJECT_STORE_1).createIndex("Int", DB.INDEX1_ON_OBJECT_STORE_1);
            				},
            				"3": function(versionTransaction){
            					versionTransaction.deleteObjectStore(DB.OBJECT_STORE_3);
            					versionTransaction.objectStore(DB.OBJECT_STORE_2).createIndex("Number", DB.INDEX1_ON_OBJECT_STORE_2);
            				}
            			}
            		}).then(function(db, e){
            			ok(true, "Opened Database with schema");
            			equals(db.objectStoreNames.length, 2, "Count of object Stores");
            			_("DB with version opened");
            			start();
            		}, function(err, e){
            			ok(false, "Could not open DB with schema");
            			_("Could not open DB with schema");
            			start();
            		}, function(res, e){
            			equals(e.type, "upgradeneeded", "Blocked due to upgrade needed");
            			_(this, arguments)
            			start();
            			stop();
            		});
            	});
            });
        </script>
    </head>
    <body>
        <h1 id="qunit-header">Jquery IndexedDB Tests</h1>
        <h2 id="qunit-banner"></h2>
        <div id="qunit-testrunner-toolbar">
        </div>
        <h2 id="qunit-userAgent"></h2>
        <ol id="qunit-tests">
        </ol>
        <div id="qunit-fixture">
            test markup, will be hidden
        </div>
    </body>
</html>
